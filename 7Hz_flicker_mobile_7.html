<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>视觉研究 - 7Hz刺激</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
  }
  
  html, body {
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: #000;
    position: fixed;
    top: 0;
    left: 0;
  }
  
  #controlPanel {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    text-align: center;
    z-index: 1000;
    padding: 20px;
  }
  
  .warning {
    color: #ff4444;
    font-weight: bold;
    margin: 10px 0;
  }
  
  input[type="checkbox"] {
    transform: scale(1.3);
    margin-right: 8px;
  }
  
  button {
    margin: 15px;
    padding: 12px 24px;
    font-size: 1.1rem;
    border-radius: 10px;
    border: none;
    background: #007AFF;
    color: white;
    cursor: pointer;
  }
  
  button:active {
    background: #0056CC;
  }
  
  button:disabled {
    background: #666;
    cursor: not-allowed;
  }
  
  .info-text {
    max-width: 320px;
    text-align: left;
    margin: 15px 0;
    line-height: 1.4;
  }
  
  #status {
    position: fixed;
    top: 10px;
    right: 10px;
    color: white;
    font-size: 12px;
    z-index: 1001;
  }
  
  .frequency-display {
    font-size: 1.2rem;
    font-weight: bold;
    color: #007AFF;
    margin: 5px 0;
  }
</style>
</head>
<body>
<div id="status"></div>
<div id="controlPanel">
  <h2>⚠️ 视觉研究程序</h2>
  <div class="frequency-display">7Hz 频率视觉刺激</div>
  <p class="warning">光敏性癫痫警告</p>
  <div class="info-text">
    <p>• 请在光线充足环境下使用</p>
    <p>• 保持观看距离 ≥ 40cm</p>
    <p>• 如感不适请立即停止</p>
    <p>• 本程序仅供研究使用</p>
  </div>
  <div style="margin: 15px 0;">
    <label>
      <input type="checkbox" id="agree"> 
      我已了解风险并同意继续
    </label>
  </div>
  <button id="startBtn">开始视觉刺激</button>
  <p style="font-size: 0.8rem; margin-top: 20px; opacity: 0.7;">
    点击屏幕任意位置可随时停止
  </p>
</div>

<script>
// 防止iOS Safari的各种限制
let flashing = false;
let animationId = null;
let startTime = 0;
const flashFreq = 7; // 改为7Hz
const interval = 1000 / (flashFreq * 2); // 约71.4ms per state

// 阻止默认行为和缩放
document.addEventListener('touchstart', function(e) {
  if (e.touches.length > 1) {
    e.preventDefault();
  }
}, { passive: false });

document.addEventListener('touchend', function(e) {
  if (flashing) {
    stopFlicker();
  }
}, { passive: false });

document.addEventListener('gesturestart', function(e) {
  e.preventDefault();
});

document.addEventListener('gesturechange', function(e) {
  e.preventDefault();
});

document.addEventListener('gestureend', function(e) {
  e.preventDefault();
});

// 防止双击缩放
let lastTouchEnd = 0;
document.addEventListener('touchend', function(event) {
  const now = (new Date()).getTime();
  if (now - lastTouchEnd <= 300) {
    event.preventDefault();
  }
  lastTouchEnd = now;
}, false);

// 元素引用
const body = document.body;
const panel = document.getElementById('controlPanel');
const startBtn = document.getElementById('startBtn');
const agree = document.getElementById('agree');
const status = document.getElementById('status');

// 启动闪烁
startBtn.addEventListener('click', function() {
  if (!agree.checked) {
    alert('请先确认了解风险');
    return;
  }
  
  // 隐藏控制面板
  panel.style.display = 'none';
  
  // 防止屏幕锁定
  keepAwake();
  
  // 开始闪烁
  startFlicker();
});

// 保持屏幕唤醒
function keepAwake() {
  if (navigator.wakeLock) {
    navigator.wakeLock.request('screen').catch(() => {});
  }
}

// 开始闪烁
function startFlicker() {
  flashing = true;
  startTime = Date.now();
  let lastSwitch = 0;
  let colorState = false;
  
  function flicker(timestamp) {
    if (!flashing) return;
    
    const currentTime = Date.now();
    const elapsed = currentTime - lastSwitch;
    
    if (elapsed >= interval) {
      colorState = !colorState;
      // 使用多种方式确保颜色切换
      body.style.backgroundColor = colorState ? '#FFFFFF' : '#000000';
      body.style.background = colorState ? '#FFFFFF' : '#000000';
      document.documentElement.style.backgroundColor = colorState ? '#FFFFFF' : '#000000';
      
      lastSwitch = currentTime;
    }
    
    // 更新状态显示
    const runningTime = Math.floor((currentTime - startTime) / 1000);
    status.textContent = `${flashFreq}Hz - ${runningTime}s`;
    
    // 30分钟自动停止
    if (currentTime - startTime < 30 * 60 * 1000) {
      animationId = requestAnimationFrame(flicker);
    } else {
      stopFlicker();
    }
  }
  
  // 强制重绘
  body.style.display = 'none';
  body.offsetHeight; // 触发重排
  body.style.display = 'block';
  
  animationId = requestAnimationFrame(flicker);
}

// 停止闪烁
function stopFlicker() {
  flashing = false;
  if (animationId) {
    cancelAnimationFrame(animationId);
    animationId = null;
  }
  
  // 恢复黑色背景
  body.style.backgroundColor = '#000000';
  body.style.background = '#000000';
  document.documentElement.style.backgroundColor = '#000000';
  
  // 显示控制面板
  panel.style.display = 'flex';
  status.textContent = '';
  
  // 释放唤醒锁
  if (navigator.wakeLock) {
    navigator.wakeLock.release('screen').catch(() => {});
  }
}

// 页面可见性变化处理
document.addEventListener('visibilitychange', function() {
  if (document.hidden && flashing) {
    // 页面被隐藏时暂停闪烁
    const tempFlashing = flashing;
    stopFlicker();
    flashing = tempFlashing;
  } else if (!document.hidden && flashing) {
    // 页面重新可见时恢复闪烁
    startFlicker();
  }
});

// 防止页面卸载时的警告
window.addEventListener('beforeunload', function(e) {
  if (flashing) {
    e.preventDefault();
    e.returnValue = '';
    return '';
  }
});

// 初始化
document.addEventListener('DOMContentLoaded', function() {
  // 强制布局以确保渲染
  setTimeout(() => {
    body.style.backgroundColor = '#000000';
  }, 100);
});
</script>
</body>
</html>